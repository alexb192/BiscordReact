{"ast":null,"code":"'use strict';\n\nconst log = require('npmlog');\n\nconst execFile = require('child_process').execFile;\n\nconst path = require('path').win32;\n\nconst logWithPrefix = require('./util').logWithPrefix;\n\nconst regSearchKeys = require('./util').regSearchKeys;\n\nfunction findVisualStudio(nodeSemver, configMsvsVersion, callback) {\n  const finder = new VisualStudioFinder(nodeSemver, configMsvsVersion, callback);\n  finder.findVisualStudio();\n}\n\nfunction VisualStudioFinder(nodeSemver, configMsvsVersion, callback) {\n  this.nodeSemver = nodeSemver;\n  this.configMsvsVersion = configMsvsVersion;\n  this.callback = callback;\n  this.errorLog = [];\n  this.validVersions = [];\n}\n\nVisualStudioFinder.prototype = {\n  log: logWithPrefix(log, 'find VS'),\n  regSearchKeys: regSearchKeys,\n  // Logs a message at verbose level, but also saves it to be displayed later\n  // at error level if an error occurs. This should help diagnose the problem.\n  addLog: function addLog(message) {\n    this.log.verbose(message);\n    this.errorLog.push(message);\n  },\n  findVisualStudio: function findVisualStudio() {\n    this.configVersionYear = null;\n    this.configPath = null;\n\n    if (this.configMsvsVersion) {\n      this.addLog('msvs_version was set from command line or npm config');\n\n      if (this.configMsvsVersion.match(/^\\d{4}$/)) {\n        this.configVersionYear = parseInt(this.configMsvsVersion, 10);\n        this.addLog(`- looking for Visual Studio version ${this.configVersionYear}`);\n      } else {\n        this.configPath = path.resolve(this.configMsvsVersion);\n        this.addLog(`- looking for Visual Studio installed in \"${this.configPath}\"`);\n      }\n    } else {\n      this.addLog('msvs_version not set from command line or npm config');\n    }\n\n    if (process.env.VCINSTALLDIR) {\n      this.envVcInstallDir = path.resolve(process.env.VCINSTALLDIR, '..');\n      this.addLog('running in VS Command Prompt, installation path is:\\n' + `\"${this.envVcInstallDir}\"\\n- will only use this version`);\n    } else {\n      this.addLog('VCINSTALLDIR not set, not running in VS Command Prompt');\n    }\n\n    this.findVisualStudio2017OrNewer(info => {\n      if (info) {\n        return this.succeed(info);\n      }\n\n      this.findVisualStudio2015(info => {\n        if (info) {\n          return this.succeed(info);\n        }\n\n        this.findVisualStudio2013(info => {\n          if (info) {\n            return this.succeed(info);\n          }\n\n          this.fail();\n        });\n      });\n    });\n  },\n  succeed: function succeed(info) {\n    this.log.info(`using VS${info.versionYear} (${info.version}) found at:` + `\\n\"${info.path}\"` + '\\nrun with --verbose for detailed information');\n    process.nextTick(this.callback.bind(null, null, info));\n  },\n  fail: function fail() {\n    if (this.configMsvsVersion && this.envVcInstallDir) {\n      this.errorLog.push('msvs_version does not match this VS Command Prompt or the', 'installation cannot be used.');\n    } else if (this.configMsvsVersion) {\n      // If msvs_version was specified but finding VS failed, print what would\n      // have been accepted\n      this.errorLog.push('');\n\n      if (this.validVersions) {\n        this.errorLog.push('valid versions for msvs_version:');\n        this.validVersions.forEach(version => {\n          this.errorLog.push(`- \"${version}\"`);\n        });\n      } else {\n        this.errorLog.push('no valid versions for msvs_version were found');\n      }\n    }\n\n    const errorLog = this.errorLog.join('\\n'); // For Windows 80 col console, use up to the column before the one marked\n    // with X (total 79 chars including logger prefix, 62 chars usable here):\n    //                                                               X\n\n    const infoLog = ['**************************************************************', 'You need to install the latest version of Visual Studio', 'including the \"Desktop development with C++\" workload.', 'For more information consult the documentation at:', 'https://github.com/nodejs/node-gyp#on-windows', '**************************************************************'].join('\\n');\n    this.log.error(`\\n${errorLog}\\n\\n${infoLog}\\n`);\n    process.nextTick(this.callback.bind(null, new Error('Could not find any Visual Studio installation to use')));\n  },\n  // Invoke the PowerShell script to get information about Visual Studio 2017\n  // or newer installations\n  findVisualStudio2017OrNewer: function findVisualStudio2017OrNewer(cb) {\n    var ps = path.join(process.env.SystemRoot, 'System32', 'WindowsPowerShell', 'v1.0', 'powershell.exe');\n    var csFile = path.join(__dirname, 'Find-VisualStudio.cs');\n    var psArgs = ['-ExecutionPolicy', 'Unrestricted', '-NoProfile', '-Command', '&{Add-Type -Path \\'' + csFile + '\\';' + '[VisualStudioConfiguration.Main]::PrintJson()}'];\n    this.log.silly('Running', ps, psArgs);\n    var child = execFile(ps, psArgs, {\n      encoding: 'utf8'\n    }, (err, stdout, stderr) => {\n      this.parseData(err, stdout, stderr, cb);\n    });\n    child.stdin.end();\n  },\n  // Parse the output of the PowerShell script and look for an installation\n  // of Visual Studio 2017 or newer to use\n  parseData: function parseData(err, stdout, stderr, cb) {\n    this.log.silly('PS stderr = %j', stderr);\n\n    const failPowershell = () => {\n      this.addLog('could not use PowerShell to find Visual Studio 2017 or newer');\n      cb(null);\n    };\n\n    if (err) {\n      this.log.silly('PS err = %j', err && (err.stack || err));\n      return failPowershell();\n    }\n\n    var vsInfo;\n\n    try {\n      vsInfo = JSON.parse(stdout);\n    } catch (e) {\n      this.log.silly('PS stdout = %j', stdout);\n      this.log.silly(e);\n      return failPowershell();\n    }\n\n    if (!Array.isArray(vsInfo)) {\n      this.log.silly('PS stdout = %j', stdout);\n      return failPowershell();\n    }\n\n    vsInfo = vsInfo.map(info => {\n      this.log.silly(`processing installation: \"${info.path}\"`);\n      info.path = path.resolve(info.path);\n      var ret = this.getVersionInfo(info);\n      ret.path = info.path;\n      ret.msBuild = this.getMSBuild(info, ret.versionYear);\n      ret.toolset = this.getToolset(info, ret.versionYear);\n      ret.sdk = this.getSDK(info);\n      return ret;\n    });\n    this.log.silly('vsInfo:', vsInfo); // Remove future versions or errors parsing version number\n\n    vsInfo = vsInfo.filter(info => {\n      if (info.versionYear) {\n        return true;\n      }\n\n      this.addLog(`unknown version \"${info.version}\" found at \"${info.path}\"`);\n      return false;\n    }); // Sort to place newer versions first\n\n    vsInfo.sort((a, b) => b.versionYear - a.versionYear);\n\n    for (var i = 0; i < vsInfo.length; ++i) {\n      const info = vsInfo[i];\n      this.addLog(`checking VS${info.versionYear} (${info.version}) found ` + `at:\\n\"${info.path}\"`);\n\n      if (info.msBuild) {\n        this.addLog('- found \"Visual Studio C++ core features\"');\n      } else {\n        this.addLog('- \"Visual Studio C++ core features\" missing');\n        continue;\n      }\n\n      if (info.toolset) {\n        this.addLog(`- found VC++ toolset: ${info.toolset}`);\n      } else {\n        this.addLog('- missing any VC++ toolset');\n        continue;\n      }\n\n      if (info.sdk) {\n        this.addLog(`- found Windows SDK: ${info.sdk}`);\n      } else {\n        this.addLog('- missing any Windows SDK');\n        continue;\n      }\n\n      if (!this.checkConfigVersion(info.versionYear, info.path)) {\n        continue;\n      }\n\n      return cb(info);\n    }\n\n    this.addLog('could not find a version of Visual Studio 2017 or newer to use');\n    cb(null);\n  },\n  // Helper - process version information\n  getVersionInfo: function getVersionInfo(info) {\n    const match = /^(\\d+)\\.(\\d+)\\..*/.exec(info.version);\n\n    if (!match) {\n      this.log.silly('- failed to parse version:', info.version);\n      return {};\n    }\n\n    this.log.silly('- version match = %j', match);\n    var ret = {\n      version: info.version,\n      versionMajor: parseInt(match[1], 10),\n      versionMinor: parseInt(match[2], 10)\n    };\n\n    if (ret.versionMajor === 15) {\n      ret.versionYear = 2017;\n      return ret;\n    }\n\n    if (ret.versionMajor === 16) {\n      ret.versionYear = 2019;\n      return ret;\n    }\n\n    this.log.silly('- unsupported version:', ret.versionMajor);\n    return {};\n  },\n  // Helper - process MSBuild information\n  getMSBuild: function getMSBuild(info, versionYear) {\n    const pkg = 'Microsoft.VisualStudio.VC.MSBuild.Base';\n\n    if (info.packages.indexOf(pkg) !== -1) {\n      this.log.silly('- found VC.MSBuild.Base');\n\n      if (versionYear === 2017) {\n        return path.join(info.path, 'MSBuild', '15.0', 'Bin', 'MSBuild.exe');\n      }\n\n      if (versionYear === 2019) {\n        return path.join(info.path, 'MSBuild', 'Current', 'Bin', 'MSBuild.exe');\n      }\n    }\n\n    return null;\n  },\n  // Helper - process toolset information\n  getToolset: function getToolset(info, versionYear) {\n    const pkg = 'Microsoft.VisualStudio.Component.VC.Tools.x86.x64';\n    const express = 'Microsoft.VisualStudio.WDExpress';\n\n    if (info.packages.indexOf(pkg) !== -1) {\n      this.log.silly('- found VC.Tools.x86.x64');\n    } else if (info.packages.indexOf(express) !== -1) {\n      this.log.silly('- found Visual Studio Express (looking for toolset)');\n    } else {\n      return null;\n    }\n\n    if (versionYear === 2017) {\n      return 'v141';\n    } else if (versionYear === 2019) {\n      return 'v142';\n    }\n\n    this.log.silly('- invalid versionYear:', versionYear);\n    return null;\n  },\n  // Helper - process Windows SDK information\n  getSDK: function getSDK(info) {\n    const win8SDK = 'Microsoft.VisualStudio.Component.Windows81SDK';\n    const win10SDKPrefix = 'Microsoft.VisualStudio.Component.Windows10SDK.';\n    var Win10SDKVer = 0;\n    info.packages.forEach(pkg => {\n      if (!pkg.startsWith(win10SDKPrefix)) {\n        return;\n      }\n\n      const parts = pkg.split('.');\n\n      if (parts.length > 5 && parts[5] !== 'Desktop') {\n        this.log.silly('- ignoring non-Desktop Win10SDK:', pkg);\n        return;\n      }\n\n      const foundSdkVer = parseInt(parts[4], 10);\n\n      if (isNaN(foundSdkVer)) {\n        // Microsoft.VisualStudio.Component.Windows10SDK.IpOverUsb\n        this.log.silly('- failed to parse Win10SDK number:', pkg);\n        return;\n      }\n\n      this.log.silly('- found Win10SDK:', foundSdkVer);\n      Win10SDKVer = Math.max(Win10SDKVer, foundSdkVer);\n    });\n\n    if (Win10SDKVer !== 0) {\n      return `10.0.${Win10SDKVer}.0`;\n    } else if (info.packages.indexOf(win8SDK) !== -1) {\n      this.log.silly('- found Win8SDK');\n      return '8.1';\n    }\n\n    return null;\n  },\n  // Find an installation of Visual Studio 2015 to use\n  findVisualStudio2015: function findVisualStudio2015(cb) {\n    return this.findOldVS({\n      version: '14.0',\n      versionMajor: 14,\n      versionMinor: 0,\n      versionYear: 2015,\n      toolset: 'v140'\n    }, cb);\n  },\n  // Find an installation of Visual Studio 2013 to use\n  findVisualStudio2013: function findVisualStudio2013(cb) {\n    if (this.nodeSemver.major >= 9) {\n      this.addLog('not looking for VS2013 as it is only supported up to Node.js 8');\n      return cb(null);\n    }\n\n    return this.findOldVS({\n      version: '12.0',\n      versionMajor: 12,\n      versionMinor: 0,\n      versionYear: 2013,\n      toolset: 'v120'\n    }, cb);\n  },\n  // Helper - common code for VS2013 and VS2015\n  findOldVS: function findOldVS(info, cb) {\n    const regVC7 = ['HKLM\\\\Software\\\\Microsoft\\\\VisualStudio\\\\SxS\\\\VC7', 'HKLM\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\VisualStudio\\\\SxS\\\\VC7'];\n    const regMSBuild = 'HKLM\\\\Software\\\\Microsoft\\\\MSBuild\\\\ToolsVersions';\n    this.addLog(`looking for Visual Studio ${info.versionYear}`);\n    this.regSearchKeys(regVC7, info.version, [], (err, res) => {\n      if (err) {\n        this.addLog('- not found');\n        return cb(null);\n      }\n\n      const vsPath = path.resolve(res, '..');\n      this.addLog(`- found in \"${vsPath}\"`);\n      const msBuildRegOpts = process.arch === 'ia32' ? [] : ['/reg:32'];\n      this.regSearchKeys([`${regMSBuild}\\\\${info.version}`], 'MSBuildToolsPath', msBuildRegOpts, (err, res) => {\n        if (err) {\n          this.addLog('- could not find MSBuild in registry for this version');\n          return cb(null);\n        }\n\n        const msBuild = path.join(res, 'MSBuild.exe');\n        this.addLog(`- MSBuild in \"${msBuild}\"`);\n\n        if (!this.checkConfigVersion(info.versionYear, vsPath)) {\n          return cb(null);\n        }\n\n        info.path = vsPath;\n        info.msBuild = msBuild;\n        info.sdk = null;\n        cb(info);\n      });\n    });\n  },\n  // After finding a usable version of Visual Stuido:\n  // - add it to validVersions to be displayed at the end if a specific\n  //   version was requested and not found;\n  // - check if this is the version that was requested.\n  // - check if this matches the Visual Studio Command Prompt\n  checkConfigVersion: function checkConfigVersion(versionYear, vsPath) {\n    this.validVersions.push(versionYear);\n    this.validVersions.push(vsPath);\n\n    if (this.configVersionYear && this.configVersionYear !== versionYear) {\n      this.addLog('- msvs_version does not match this version');\n      return false;\n    }\n\n    if (this.configPath && path.relative(this.configPath, vsPath) !== '') {\n      this.addLog('- msvs_version does not point to this installation');\n      return false;\n    }\n\n    if (this.envVcInstallDir && path.relative(this.envVcInstallDir, vsPath) !== '') {\n      this.addLog('- does not match this Visual Studio Command Prompt');\n      return false;\n    }\n\n    return true;\n  }\n};\nmodule.exports = findVisualStudio;\nmodule.exports.test = {\n  VisualStudioFinder: VisualStudioFinder,\n  findVisualStudio: findVisualStudio\n};","map":{"version":3,"sources":["/home/n/React/loginpagedemo/frontend/node_modules/node-gyp/lib/find-visualstudio.js"],"names":["log","require","execFile","path","win32","logWithPrefix","regSearchKeys","findVisualStudio","nodeSemver","configMsvsVersion","callback","finder","VisualStudioFinder","errorLog","validVersions","prototype","addLog","message","verbose","push","configVersionYear","configPath","match","parseInt","resolve","process","env","VCINSTALLDIR","envVcInstallDir","findVisualStudio2017OrNewer","info","succeed","findVisualStudio2015","findVisualStudio2013","fail","versionYear","version","nextTick","bind","forEach","join","infoLog","error","Error","cb","ps","SystemRoot","csFile","__dirname","psArgs","silly","child","encoding","err","stdout","stderr","parseData","stdin","end","failPowershell","stack","vsInfo","JSON","parse","e","Array","isArray","map","ret","getVersionInfo","msBuild","getMSBuild","toolset","getToolset","sdk","getSDK","filter","sort","a","b","i","length","checkConfigVersion","exec","versionMajor","versionMinor","pkg","packages","indexOf","express","win8SDK","win10SDKPrefix","Win10SDKVer","startsWith","parts","split","foundSdkVer","isNaN","Math","max","findOldVS","major","regVC7","regMSBuild","res","vsPath","msBuildRegOpts","arch","relative","module","exports","test"],"mappings":"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","sourcesContent":["'use strict'\n\nconst log = require('npmlog')\nconst execFile = require('child_process').execFile\nconst path = require('path').win32\nconst logWithPrefix = require('./util').logWithPrefix\nconst regSearchKeys = require('./util').regSearchKeys\n\nfunction findVisualStudio (nodeSemver, configMsvsVersion, callback) {\n  const finder = new VisualStudioFinder(nodeSemver, configMsvsVersion,\n    callback)\n  finder.findVisualStudio()\n}\n\nfunction VisualStudioFinder (nodeSemver, configMsvsVersion, callback) {\n  this.nodeSemver = nodeSemver\n  this.configMsvsVersion = configMsvsVersion\n  this.callback = callback\n  this.errorLog = []\n  this.validVersions = []\n}\n\nVisualStudioFinder.prototype = {\n  log: logWithPrefix(log, 'find VS'),\n\n  regSearchKeys: regSearchKeys,\n\n  // Logs a message at verbose level, but also saves it to be displayed later\n  // at error level if an error occurs. This should help diagnose the problem.\n  addLog: function addLog (message) {\n    this.log.verbose(message)\n    this.errorLog.push(message)\n  },\n\n  findVisualStudio: function findVisualStudio () {\n    this.configVersionYear = null\n    this.configPath = null\n    if (this.configMsvsVersion) {\n      this.addLog('msvs_version was set from command line or npm config')\n      if (this.configMsvsVersion.match(/^\\d{4}$/)) {\n        this.configVersionYear = parseInt(this.configMsvsVersion, 10)\n        this.addLog(\n          `- looking for Visual Studio version ${this.configVersionYear}`)\n      } else {\n        this.configPath = path.resolve(this.configMsvsVersion)\n        this.addLog(\n          `- looking for Visual Studio installed in \"${this.configPath}\"`)\n      }\n    } else {\n      this.addLog('msvs_version not set from command line or npm config')\n    }\n\n    if (process.env.VCINSTALLDIR) {\n      this.envVcInstallDir =\n        path.resolve(process.env.VCINSTALLDIR, '..')\n      this.addLog('running in VS Command Prompt, installation path is:\\n' +\n        `\"${this.envVcInstallDir}\"\\n- will only use this version`)\n    } else {\n      this.addLog('VCINSTALLDIR not set, not running in VS Command Prompt')\n    }\n\n    this.findVisualStudio2017OrNewer((info) => {\n      if (info) {\n        return this.succeed(info)\n      }\n      this.findVisualStudio2015((info) => {\n        if (info) {\n          return this.succeed(info)\n        }\n        this.findVisualStudio2013((info) => {\n          if (info) {\n            return this.succeed(info)\n          }\n          this.fail()\n        })\n      })\n    })\n  },\n\n  succeed: function succeed (info) {\n    this.log.info(`using VS${info.versionYear} (${info.version}) found at:` +\n                  `\\n\"${info.path}\"` +\n                  '\\nrun with --verbose for detailed information')\n    process.nextTick(this.callback.bind(null, null, info))\n  },\n\n  fail: function fail () {\n    if (this.configMsvsVersion && this.envVcInstallDir) {\n      this.errorLog.push(\n        'msvs_version does not match this VS Command Prompt or the',\n        'installation cannot be used.')\n    } else if (this.configMsvsVersion) {\n      // If msvs_version was specified but finding VS failed, print what would\n      // have been accepted\n      this.errorLog.push('')\n      if (this.validVersions) {\n        this.errorLog.push('valid versions for msvs_version:')\n        this.validVersions.forEach((version) => {\n          this.errorLog.push(`- \"${version}\"`)\n        })\n      } else {\n        this.errorLog.push('no valid versions for msvs_version were found')\n      }\n    }\n\n    const errorLog = this.errorLog.join('\\n')\n\n    // For Windows 80 col console, use up to the column before the one marked\n    // with X (total 79 chars including logger prefix, 62 chars usable here):\n    //                                                               X\n    const infoLog = [\n      '**************************************************************',\n      'You need to install the latest version of Visual Studio',\n      'including the \"Desktop development with C++\" workload.',\n      'For more information consult the documentation at:',\n      'https://github.com/nodejs/node-gyp#on-windows',\n      '**************************************************************'\n    ].join('\\n')\n\n    this.log.error(`\\n${errorLog}\\n\\n${infoLog}\\n`)\n    process.nextTick(this.callback.bind(null, new Error(\n      'Could not find any Visual Studio installation to use')))\n  },\n\n  // Invoke the PowerShell script to get information about Visual Studio 2017\n  // or newer installations\n  findVisualStudio2017OrNewer: function findVisualStudio2017OrNewer (cb) {\n    var ps = path.join(process.env.SystemRoot, 'System32',\n      'WindowsPowerShell', 'v1.0', 'powershell.exe')\n    var csFile = path.join(__dirname, 'Find-VisualStudio.cs')\n    var psArgs = [\n      '-ExecutionPolicy',\n      'Unrestricted',\n      '-NoProfile',\n      '-Command',\n      '&{Add-Type -Path \\'' + csFile + '\\';' + '[VisualStudioConfiguration.Main]::PrintJson()}'\n    ]\n\n    this.log.silly('Running', ps, psArgs)\n    var child = execFile(ps, psArgs, { encoding: 'utf8' },\n      (err, stdout, stderr) => {\n        this.parseData(err, stdout, stderr, cb)\n      })\n    child.stdin.end()\n  },\n\n  // Parse the output of the PowerShell script and look for an installation\n  // of Visual Studio 2017 or newer to use\n  parseData: function parseData (err, stdout, stderr, cb) {\n    this.log.silly('PS stderr = %j', stderr)\n\n    const failPowershell = () => {\n      this.addLog(\n        'could not use PowerShell to find Visual Studio 2017 or newer')\n      cb(null)\n    }\n\n    if (err) {\n      this.log.silly('PS err = %j', err && (err.stack || err))\n      return failPowershell()\n    }\n\n    var vsInfo\n    try {\n      vsInfo = JSON.parse(stdout)\n    } catch (e) {\n      this.log.silly('PS stdout = %j', stdout)\n      this.log.silly(e)\n      return failPowershell()\n    }\n\n    if (!Array.isArray(vsInfo)) {\n      this.log.silly('PS stdout = %j', stdout)\n      return failPowershell()\n    }\n\n    vsInfo = vsInfo.map((info) => {\n      this.log.silly(`processing installation: \"${info.path}\"`)\n      info.path = path.resolve(info.path)\n      var ret = this.getVersionInfo(info)\n      ret.path = info.path\n      ret.msBuild = this.getMSBuild(info, ret.versionYear)\n      ret.toolset = this.getToolset(info, ret.versionYear)\n      ret.sdk = this.getSDK(info)\n      return ret\n    })\n    this.log.silly('vsInfo:', vsInfo)\n\n    // Remove future versions or errors parsing version number\n    vsInfo = vsInfo.filter((info) => {\n      if (info.versionYear) {\n        return true\n      }\n      this.addLog(`unknown version \"${info.version}\" found at \"${info.path}\"`)\n      return false\n    })\n\n    // Sort to place newer versions first\n    vsInfo.sort((a, b) => b.versionYear - a.versionYear)\n\n    for (var i = 0; i < vsInfo.length; ++i) {\n      const info = vsInfo[i]\n      this.addLog(`checking VS${info.versionYear} (${info.version}) found ` +\n                  `at:\\n\"${info.path}\"`)\n\n      if (info.msBuild) {\n        this.addLog('- found \"Visual Studio C++ core features\"')\n      } else {\n        this.addLog('- \"Visual Studio C++ core features\" missing')\n        continue\n      }\n\n      if (info.toolset) {\n        this.addLog(`- found VC++ toolset: ${info.toolset}`)\n      } else {\n        this.addLog('- missing any VC++ toolset')\n        continue\n      }\n\n      if (info.sdk) {\n        this.addLog(`- found Windows SDK: ${info.sdk}`)\n      } else {\n        this.addLog('- missing any Windows SDK')\n        continue\n      }\n\n      if (!this.checkConfigVersion(info.versionYear, info.path)) {\n        continue\n      }\n\n      return cb(info)\n    }\n\n    this.addLog(\n      'could not find a version of Visual Studio 2017 or newer to use')\n    cb(null)\n  },\n\n  // Helper - process version information\n  getVersionInfo: function getVersionInfo (info) {\n    const match = /^(\\d+)\\.(\\d+)\\..*/.exec(info.version)\n    if (!match) {\n      this.log.silly('- failed to parse version:', info.version)\n      return {}\n    }\n    this.log.silly('- version match = %j', match)\n    var ret = {\n      version: info.version,\n      versionMajor: parseInt(match[1], 10),\n      versionMinor: parseInt(match[2], 10)\n    }\n    if (ret.versionMajor === 15) {\n      ret.versionYear = 2017\n      return ret\n    }\n    if (ret.versionMajor === 16) {\n      ret.versionYear = 2019\n      return ret\n    }\n    this.log.silly('- unsupported version:', ret.versionMajor)\n    return {}\n  },\n\n  // Helper - process MSBuild information\n  getMSBuild: function getMSBuild (info, versionYear) {\n    const pkg = 'Microsoft.VisualStudio.VC.MSBuild.Base'\n    if (info.packages.indexOf(pkg) !== -1) {\n      this.log.silly('- found VC.MSBuild.Base')\n      if (versionYear === 2017) {\n        return path.join(info.path, 'MSBuild', '15.0', 'Bin', 'MSBuild.exe')\n      }\n      if (versionYear === 2019) {\n        return path.join(info.path, 'MSBuild', 'Current', 'Bin', 'MSBuild.exe')\n      }\n    }\n    return null\n  },\n\n  // Helper - process toolset information\n  getToolset: function getToolset (info, versionYear) {\n    const pkg = 'Microsoft.VisualStudio.Component.VC.Tools.x86.x64'\n    const express = 'Microsoft.VisualStudio.WDExpress'\n\n    if (info.packages.indexOf(pkg) !== -1) {\n      this.log.silly('- found VC.Tools.x86.x64')\n    } else if (info.packages.indexOf(express) !== -1) {\n      this.log.silly('- found Visual Studio Express (looking for toolset)')\n    } else {\n      return null\n    }\n\n    if (versionYear === 2017) {\n      return 'v141'\n    } else if (versionYear === 2019) {\n      return 'v142'\n    }\n    this.log.silly('- invalid versionYear:', versionYear)\n    return null\n  },\n\n  // Helper - process Windows SDK information\n  getSDK: function getSDK (info) {\n    const win8SDK = 'Microsoft.VisualStudio.Component.Windows81SDK'\n    const win10SDKPrefix = 'Microsoft.VisualStudio.Component.Windows10SDK.'\n\n    var Win10SDKVer = 0\n    info.packages.forEach((pkg) => {\n      if (!pkg.startsWith(win10SDKPrefix)) {\n        return\n      }\n      const parts = pkg.split('.')\n      if (parts.length > 5 && parts[5] !== 'Desktop') {\n        this.log.silly('- ignoring non-Desktop Win10SDK:', pkg)\n        return\n      }\n      const foundSdkVer = parseInt(parts[4], 10)\n      if (isNaN(foundSdkVer)) {\n        // Microsoft.VisualStudio.Component.Windows10SDK.IpOverUsb\n        this.log.silly('- failed to parse Win10SDK number:', pkg)\n        return\n      }\n      this.log.silly('- found Win10SDK:', foundSdkVer)\n      Win10SDKVer = Math.max(Win10SDKVer, foundSdkVer)\n    })\n\n    if (Win10SDKVer !== 0) {\n      return `10.0.${Win10SDKVer}.0`\n    } else if (info.packages.indexOf(win8SDK) !== -1) {\n      this.log.silly('- found Win8SDK')\n      return '8.1'\n    }\n    return null\n  },\n\n  // Find an installation of Visual Studio 2015 to use\n  findVisualStudio2015: function findVisualStudio2015 (cb) {\n    return this.findOldVS({\n      version: '14.0',\n      versionMajor: 14,\n      versionMinor: 0,\n      versionYear: 2015,\n      toolset: 'v140'\n    }, cb)\n  },\n\n  // Find an installation of Visual Studio 2013 to use\n  findVisualStudio2013: function findVisualStudio2013 (cb) {\n    if (this.nodeSemver.major >= 9) {\n      this.addLog(\n        'not looking for VS2013 as it is only supported up to Node.js 8')\n      return cb(null)\n    }\n    return this.findOldVS({\n      version: '12.0',\n      versionMajor: 12,\n      versionMinor: 0,\n      versionYear: 2013,\n      toolset: 'v120'\n    }, cb)\n  },\n\n  // Helper - common code for VS2013 and VS2015\n  findOldVS: function findOldVS (info, cb) {\n    const regVC7 = ['HKLM\\\\Software\\\\Microsoft\\\\VisualStudio\\\\SxS\\\\VC7',\n      'HKLM\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\VisualStudio\\\\SxS\\\\VC7']\n    const regMSBuild = 'HKLM\\\\Software\\\\Microsoft\\\\MSBuild\\\\ToolsVersions'\n\n    this.addLog(`looking for Visual Studio ${info.versionYear}`)\n    this.regSearchKeys(regVC7, info.version, [], (err, res) => {\n      if (err) {\n        this.addLog('- not found')\n        return cb(null)\n      }\n\n      const vsPath = path.resolve(res, '..')\n      this.addLog(`- found in \"${vsPath}\"`)\n\n      const msBuildRegOpts = process.arch === 'ia32' ? [] : ['/reg:32']\n      this.regSearchKeys([`${regMSBuild}\\\\${info.version}`],\n        'MSBuildToolsPath', msBuildRegOpts, (err, res) => {\n          if (err) {\n            this.addLog(\n              '- could not find MSBuild in registry for this version')\n            return cb(null)\n          }\n\n          const msBuild = path.join(res, 'MSBuild.exe')\n          this.addLog(`- MSBuild in \"${msBuild}\"`)\n\n          if (!this.checkConfigVersion(info.versionYear, vsPath)) {\n            return cb(null)\n          }\n\n          info.path = vsPath\n          info.msBuild = msBuild\n          info.sdk = null\n          cb(info)\n        })\n    })\n  },\n\n  // After finding a usable version of Visual Stuido:\n  // - add it to validVersions to be displayed at the end if a specific\n  //   version was requested and not found;\n  // - check if this is the version that was requested.\n  // - check if this matches the Visual Studio Command Prompt\n  checkConfigVersion: function checkConfigVersion (versionYear, vsPath) {\n    this.validVersions.push(versionYear)\n    this.validVersions.push(vsPath)\n\n    if (this.configVersionYear && this.configVersionYear !== versionYear) {\n      this.addLog('- msvs_version does not match this version')\n      return false\n    }\n    if (this.configPath &&\n        path.relative(this.configPath, vsPath) !== '') {\n      this.addLog('- msvs_version does not point to this installation')\n      return false\n    }\n    if (this.envVcInstallDir &&\n        path.relative(this.envVcInstallDir, vsPath) !== '') {\n      this.addLog('- does not match this Visual Studio Command Prompt')\n      return false\n    }\n\n    return true\n  }\n}\n\nmodule.exports = findVisualStudio\nmodule.exports.test = {\n  VisualStudioFinder: VisualStudioFinder,\n  findVisualStudio: findVisualStudio\n}\n"]},"metadata":{},"sourceType":"script"}